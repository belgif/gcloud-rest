== Document

A document resource is a _singular concept_ that is referring to a business entity or object instance. A document’s state representation typically includes both _fields with values_ and <<links,_links_>> to other related resources.

.An employer document resource
====
​​`GET {API}/employers/93017373[^]`

[subs="normal"]
```json
{
  "name": "Belgacom",
  "nossRegistrationNumber": "93017373",
  "company": {
    "companyId": "0202239951",
    "href": "{API}/companies/0202239951[^]"
  },
  "self": "{API}/employers/93017373[^]"
}
```
====

*Child resources*

A document may have _child resources_ that represent its specific subordinate concepts. Most document resources are contained in a _parent <<Collection,collection resource>>_ and define a *variable path segment with identity key*.

image::collection.png[]

When defining child resources, stick to concepts _within the same API_. An employer resource could contain child concepts as employees, debts, taxes, mandates, declarations, risks, but putting all these different concepts below a single document resource becomes unmanageable. In that case *prefer associations and create <<document-links,links>>* to other APIs from the employer resource.

*Identity key*

The _identity key_ is preferably a _natural business identifier_, uniquely identifying the business resource. If such key does not exist, a _surrogate or technical key_ (like http://tools.ietf.org/html/rfc4122[UUID^]) can be used.

WARNING: Especially for unsecured resources, avoid technical keys that are easy to guess (for example sequential identifiers)

WARNING: Don't use database-generated keys as identity keys in your public API to avoid tight coupling between the database schema and API. Having the key independent of all other columns insulates the database relationships from changes in data values or database design (agility) and guarantees uniqueness.


=== Consult

.Consulting a document
====
[subs="normal"]
```
GET {API}/employers/93017373[^] HTTP/1.1
```

[cols="1,2,3"]
|===
|​​​​​​​​​<<get>>
|/employers/{employerId}
|Consult a single employer

3+|​​​Parameters

|`employerId`|path-param|CBE enterprise number uniquely identifying the employer.

3+|Response

|body
|The response properties and links to other resources.
a|
[source,json, subs="normal"]
----
​​​{
  "self": "{API}/employers/93017373[/employers/93017373^]",
  "name": "Belgacom",
  "nossRegistrationNumber": "93017373",
  "company": {
    "companyId": "0202239951",
    "href": "{API}/companies/0202239951[/companies/0202239951^]"
  }
}
----

3+|Response codes
​​|<<http-200,200>>
|OK
|Default success code if the document exists

​​|<<http-304,304>>
|Not Modified
|Used for consultations with <<Conditional requests,conditional requests>>.

|<<http-400,400>>
|Bad request
a|The dynamic path segment containing the identity key has a wrong data format

(TODO: update example with RFC7807 Problem JSON format)
[source,json]
----
{
 "id": "63b68bfa-bcdc-40f1",
 "code": "Bad Request",
 "message": "The input message is incorrect",
 "details": [
  {
   "kind": "path-param",
   "message": "This value should be numeric",
   "ref": "employerId",
   "value": "abc"
  }
 ]
}
----
​|<<http-404,404>>
|Not Found
|The document resource does not exist.
​
|===
====

=== Update

Updating a resource may be done in one of several ways.
One and only one of following patterns should be chosen per resource, unless forced by a backwards compatible change.

In order of preference:

. use PUT with complete objects to update a resource as long as feasible (i.e. do not use PATCH at all).
+
This option is preferred when clients are likely to always take into account the entire resource representation.
If a client ignores some of a resource's properties returned by a consultation, they are likely to be omitted from the PUT request and thus lost.
This scenario may occur when new properties were added during the API lifecycle.
In this case, use of PUT isn't advised.

. Use PATCH with partial objects to only update parts of a resource, whenever possible, using the JSON Merge Patch standard.
+
JSON Merge Patch is limited however, e.g. it doesn't allow for an update of a single element of an array.
If this proves to be an issue, this might however indicate that the array elements might be beter modeled as seperate subresources.

. use POST (with a proper description of what is happening) instead of PATCH if the request does not modify the resource in a way defined by the semantics of the media type.

Use of the JSON Patch standard, an alternative to JSON Merge Patch, is not recommended, as it proves to be difficult to implement.

CAUTION: guidelines how to use POST are still under discussion in issue #3

==== Full update

Use `PUT` when you like to do a complete update of a document resource. All values are replaced by the values submitted by the client.

.PUT on a document resource
====
[subs="normal"]
```
PUT {API}/employers/93017373[^] HTTP/1.1
```

[cols="1,2,3"]
|===
|​​​​​​​​​<<put>>
|/employers/{employerId}
|Replace the entire employer resource with the client data. This implies a full update of the resource. Via `PUT` the client submits new values for all the data.

3+|Request

|body
|Full representation of the resource to persist.
|

3+|​​​Parameters

|`employerId`|path-param|CBE enterprise number uniquely identifying the employer.

3+|Response

TODO: update JSON response to RFC 7807

|body
|empty or a message indicating success
a|
[source,json]
----
​​​{
 "id": "63b68bfa-bcdc-40f1",
 "code": "OK",
 "message": "Employer successfully updated"
}

----

3+|Response codes
​​|<<http-200,200>>
|OK
|Default success code if the updated succeeded

|<<http-400,400>>
|Bad request
|The input data is not valid according the data schema.

|<<http-404,404>>
|Not Found
|The resource does not exist and thus cannot be updated.
​
|<<http-409,409>>
|Conflict
|The client data is in conflict with the data on the server e.g. optimistic locking issues.
​
|===
====

==== Partial update

Use `PATCH` when you like to do a partial update of a document resource.

The `PATCH` message MUST be conform to the JSON Merge Patch (https://tools.ietf.org/html/rfc7386[RFC 7386]) specification:

* JSON properties in the request overwrite the ones in the previous resource state
* properties with value `null` in the request are removed from the resource
* properties not present in the request are preserved

APIs should support both the MIME type of JSON merge patch `application/merge-patch+json` as the generic `application/json` JSON mime type.

CAUTION: Open issue #14: representing JSON Merge Patch in JSON schema

.JSON merge patch
====
[subs="normal"]
```
PATCH {API}/employers/93017373[^] HTTP/1.1
```

[cols="1,2,3"]
|===
|​​​​​​​​​<<patch>>
|/employers/{employerId}
|Performs a partial update of an existing employer.

3+|Request

|body
|JSON Merge Patch
a|
[source,json]
----
​​​{
  "bankrupt": false,
  "bankruptDate": null
}
----

3+|​​​Parameters

|`employerId`|path-param|CBE enterprise number uniquely identifying the employer.

3+|Response

TODO: update JSON response to RFC 7807

|body
|empty or a message indicating success
a|
[source,json]
----
​​​{
 "id": "63b68bfa-bcdc-40f1",
 "code": "OK",
 "message": "Employer successfully updated"
}
----

3+|Response codes
​​|<<http-200,200>>
|OK
|Default success code if the updated succeeded

|<<http-400,400>>
|Bad request
|The input data is not valid according the data schema.

|<<http-404,404>>
|Not Found
|The resource does not exist and thus cannot be updated.
​
|<<http-409,409>>
|Conflict
|The client data is in conflict with the data on the server e.g. optimistic locking issues.
​
|===
====

=== Remove

Use `DELETE` when you like to delete a document resource.

.Deleting a document resource
====
[subs="normal"]
```
DELETE {API}/employers/93017373[^] HTTP/1.1
```

[cols="1,2,3"]
|===
|​​​​​​​​​<<delete>>
|/employers/{employerId}
|Deletes an employer.

3+|​​​Parameters

|`employerId`|path-param|CBE enterprise number uniquely identifying the employer.

3+|Response

TODO: update JSON response to RFC 7807

|body
|empty or a message indicating success
a|
[source,json]
----
​​​{
 "id": "63b68bfa-bcdc-40f1",
 "code": "OK",
 "message": "Employer successfully deleted"
}
----

3+|Response codes
​​|<<http-200,200>>
|OK
|Default success code if the updated succeeded

|<<http-400,400>>
|Bad request
|The input data is not valid according the data schema.

|<<http-404,404>>
|Not Found
|The resource does not exist and thus cannot be updated.
​
|===
====

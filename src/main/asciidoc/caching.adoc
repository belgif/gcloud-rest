== Caching ==

CAUTION: caching not part of guidelines at the moment. Further open issues in #11. Result should move to performance.adoc

=== Conditional requests
Conditional requests are those where the client can ask the server if it has an updated copy of the resource. The client will send some information about the cached resource it holds and the server will determine whether updated content should be returned or the client’s copy is the most recent. In the case of the latter an HTTP status of <<http-304,`304 Not Modified`>> is returned.

image::conditional.jpg[]

Though conditional requests do invoke a call across the network, unmodified resources result in an empty response body – saving the cost of transferring the resource back to the end client. The backend service is also often able to very quickly determine a resource’s last modified date without accessing the resource which itself saves non-trivial processing time.

==== Time-based
A time-based conditional request ensures that only if the requested resource has changed since the client copy was cached will the contents be transferred. If the cached copy is the most up-to-date then the server returns the 304 response code.
To enable conditional requests the application specifies the last modified time of a resource via the `Last-Modified` response header.
```
Cache-Control:public, max-age=31536000
Last-Modified: Mon, 03 Jan 2011 17:45:57 GMT
```

The next time the browser requests this resource it will only ask for the contents of the resource if they’re unchanged since this date using the `If-Modified-Since` request header
```
If-Modified-Since: Mon, 03 Jan 2011 17:45:57 GMT
```

If the resource hasn’t changed since `Mon, 03 Jan 2011 17:45:57 GMT` the server will return with an empty body with the <<http-304,`304`>> response code.

_Remark_: the `max-age` header precision unit is the second. It may not be precise enough if there are two updates within a second.

==== Content-based
The `ETag` (or Entity Tag) works in a similar way to the `Last-Modified` header except its value is a digest of the resources contents (for instance, an MD5 hash). This allows the server to identify if the cached contents of the resource are different to the most recent version.
This tag is useful when for when the last modified date is difficult to determine.

```
Cache-Control:public, max-age=31536000
ETag: "15f0fff99ed5aae4edffdd6496d7131f"
```

On subsequent browser requests the `If-None-Match` request header is sent with the ETag value of the last requested version of the resource.
```
If-None-Match: "15f0fff99ed5aae4edffdd6496d7131f"
```

As with the `If-Modified-Since` header, if the current version has the same ETag value, indicating its value is the same as the browser’s cached copy, then an HTTP status of <<http-304,`304`>> is returned.

==== Vary header
The "Vary" header field in a response describes what parts of a request message, aside from the method, Host header field, and request target, might influence the origin server's process for selecting and representing this response.

See https://www.fastly.com/blog/best-practices-using-vary-header[Best Practices for Using the Vary Header] for hint over the `Vary header`usage`.

Example :

* Vary: Accept-Encoding => avoid caching and serving XML response when the second request ask JSON.

*Never use* : `Vary: *`  => will result in a cache hit of 0.

==== Recommandations

The following schema shows a decision tree for the caching setup for a given resource:

image::http-cache-decision-tree.png[]

.References
****
https://devcenter.heroku.com/articles/increasing-application-performance-with-http-cache-headers[Increasing Application Performance with HTTP Cache Headers^] +
http://www.mobify.com/blog/beginners-guide-to-http-cache-headers[A Beginner's Guide to HTTP Cache Headers^] +
https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching?hl=en[Google HTTP Caching^] +
https://www.fastly.com/blog/best-practices-using-vary-header[Best Practices for Using the Vary Header]
****
